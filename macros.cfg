[gcode_macro PRINT_START]
gcode:
  ###################################################################
  # PRINT_START (Updated with Dynamic PA safe-integration)
  # - Keeps all your QGL, Eddy mesh, purge line logic unchanged
  # - Prevents double-home using _CG28
  # - Ensures Dynamic PA starts CLEAN and only when nozzle is hot
  ###################################################################

  # ---- Reset Dynamic PA state (avoids leftover PA from previous print) ----
  DPA_OFF

  # ---- Slicer parameters with safe defaults ----
  {% set target_bed       = params.BED|default(60)|int %}
  {% set target_extruder  = params.EXTRUDER|default(200)|int %}

  # ---- Geometry helpers ----
  {% set x_max   = printer.toolhead.axis_maximum.x|float %}
  {% set y_max   = printer.toolhead.axis_maximum.y|float %}
  {% set x_min   = printer.toolhead.axis_minimum.x|float %}
  {% set y_min   = printer.toolhead.axis_minimum.y|float %}
  {% set x_mid   = (x_max + x_min) / 2.0 %}
  {% set y_mid   = (y_max + y_min) / 2.0 %}

  # ---- Purge line tuning ----
  {% set purge_len     = 220 %}
  {% set purge_z       = 0.30 %}
  {% set front_margin  = 5 %}
  {% set nozzle_soak   = 120 %}

  M117 Heating bed…
  M140 S{target_bed}
  M104 S{nozzle_soak}

  # ---- CONDITIONAL HOME ONLY ----
  _CG28

  # Safe location after homing
  G90
  G1 Z20 F9000
  G1 X{x_mid} Y{y_mid} F12000

  # ---- Final bed temp + expansion settle ----
  M190 S{target_bed}
  TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={target_bed-1} MAXIMUM={target_bed+3}

  # ---- QGL (full gantry leveling) ----
  M117 QGL…
  G90
  G1 Z20 F9000
  G1 X{x_mid} Y{y_mid} F12000
  QUAD_GANTRY_LEVEL

  G90
  G1 Z20 F9000
  G1 X{x_mid} Y{y_mid} F12000

  # ---- Eddy RAPID_SCAN adaptive mesh ----
  M117 Eddy mesh…
  BED_MESH_CLEAR
  BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=1

  # Move clear of probe area
  G90
  G1 X{x_mid} Y{y_mid} Z10 F12000

  # ---- Heat hotend to print temp ----
  M117 Heating hotend…
  M109 S{target_extruder}

  # ---- Wait for safe extrude temp ----
  {% set min_ok = printer.configfile.settings.extruder.min_extrude_temp|int %}
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_ok}

  # ===================================================================
  #   Dynamic Pressure Advance Activation Point
  #
  #   IMPORTANT:
  #   - Slicer must set:
  #       DPA_SET_BASE PA=...
  #       DPA_CONFIG MIN=0.02 MAX=0.20 GAIN=0.008 DAMP=0.85
  #   - PRINT_START now turns DPA ON here.
  # ===================================================================

  DPA_ON
  M117 Dynamic PA active…

  # ---- Purge lines ----
  M117 Purge lines…
  SAVE_GCODE_STATE NAME=PRIMELINE
  G90
  G92 E0

  G1 X{ (x_min + 30) if (x_min + 30) > 30 else 30 } Y{y_min + front_margin} Z{purge_z} F12000

  G91
  G1 X{purge_len}   E18 F1200
  G1 Y1             F6000
  G1 X-{purge_len}  E9  F1200
  G90
  G92 E0
  RESTORE_GCODE_STATE NAME=PRIMELINE

  # ---- Move back to center + enable filament sensing ----
  G90
  G1 X{x_mid} Y{y_mid} F12000

  M107
  _FS_ON

  M117 Printing…

  


[gcode_macro END_PRINT]
gcode:
  ###################################################################
  # PRINT_END — Complete shutdown of motion, heaters, modifiers,
  #              and dynamic tuning systems (DPA / DFA).
  ###################################################################

  M117 Ending…

  # ----------------------------------------------------
  # 1. Clear motion + retract a little
  # ----------------------------------------------------
  G91
  G1 E-1.0 F3000             ; quick retract
  G1 Z+10 F6000              ; lift nozzle
  G90

  # Move to park (front-right by default)
  {% set x_max = printer.toolhead.axis_maximum.x %}
  {% set y_min = printer.toolhead.axis_minimum.y %}
  G1 X{x_max - 10} Y{y_min + 20} F12000

  # ----------------------------------------------------
  # 2. Disable dynamic systems (DPA + DFA)
  # ----------------------------------------------------
  DPA_OFF
  DFA_OFF
  M221 S100                  ; restore flow to 100%
   
  # HARD STOP BOTH LOOPS
  UPDATE_DELAYED_GCODE ID=DPA_LOOP DURATION=0
  UPDATE_DELAYED_GCODE ID=DFA_LOOP DURATION=0

  # Restore slicer defaults
  SET_PRESSURE_ADVANCE ADVANCE=0
  M221 S100                  ; restore flow to 100%


  # ----------------------------------------------------
  # 3. Turn off heaters + fans
  # ----------------------------------------------------
  TURN_OFF_HEATERS           ; shuts down bed + hotend
  M107                       ; part cooling fan off

  # ----------------------------------------------------
  # 4. Disable steppers
  # ----------------------------------------------------
  M84

  # ----------------------------------------------------
  # 5. Optionally disable filament sensors
  # ----------------------------------------------------
  _FS_OFF                    ; disable SFS + switch sensors if you use them

  M117 Print Finished



[gcode_macro LOAD_FILAMENT]
description: Hot load + purge with clean state handling
gcode:
  {% set temp           = params.TEMP|default(220)|int %}
  {% set load_distance  = params.LOAD_DISTANCE|default(90)|int %}
  {% set load_speed     = params.LOAD_SPEED|default(600)|int %}
  {% set purge_distance = params.PURGE_DISTANCE|default(35)|int %}
  {% set purge_speed    = params.PURGE_SPEED|default(300)|int %}

  SAVE_GCODE_STATE NAME=LOAD_STATE
  M117 Loading filament…

  # ----------------------------------------------------
  # Disable sensors during manual handling
  # ----------------------------------------------------
  SFS_DISABLE

  # ----------------------------------------------------
  # Heat to safe extrusion temperature
  # ----------------------------------------------------
  {% set min_ok = printer.configfile.settings.extruder.min_extrude_temp|int %}
  {% set target = (temp if temp >= min_ok else min_ok) %}
  M104 S{target}
  M109 S{target}

  # ----------------------------------------------------
  # Load & purge sequence
  # ----------------------------------------------------
  G91
  M83

  G1 E2   F300              ; grab tip
  G1 E{load_distance} F{load_speed}
  G1 E{purge_distance} F{purge_speed}
  G1 E-1 F1200              ; small de-stringer

  G90

  # ----------------------------------------------------
  # Re-enable sensors
  # ----------------------------------------------------
  SFS_ENABLE

  RESTORE_GCODE_STATE NAME=LOAD_STATE
  M117 Filament loaded




[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    # Parameters
    {% set z = params.Z|default(10)|int %}                                                   ; z hop amount

    {% if printer['pause_resume'].is_paused|int == 0 %}
        # Cache variables for RESUME to use
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer[printer.toolhead.extruder].target|int}

        # Avoid false runout during manual handling (disable both sensors if present)
        _FS_OFF

        SAVE_GCODE_STATE NAME=PAUSE
        BASE_PAUSE

        {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}
            G91
            G1 Z{z} F900
        {% else %}
            { action_respond_info("Pause zhop exceeds maximum Z height. Using 0.") }
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
        {% endif %}

        G90
        G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+5} F6000  ; park front/center
        SAVE_GCODE_STATE NAME=PAUSEPARK

        # Default behaviour: cool hotend on long pauses
        M104 S0
        SET_IDLE_TIMEOUT TIMEOUT=43200
    {% endif %}



[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
gcode:
    # Parameters
    {% set e = params.E|default(2.5)|int %}

    {% if printer['pause_resume'].is_paused|int == 1 %}
        # Re-enable sensors (any that exist)
        _FS_ON

        # Restore standard idle timeout
        SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}

        # If a working etemp was captured at PAUSE, go back to it
        {% if etemp|int > 0 %}
            M109 S{etemp|int}
        {% endif %}

        # Return to parked spot (in case the head moved while paused)
        RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=100

        # Lower Z and (optionally) prime
        G91
        M83
        {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
            G1 Z{zhop * -1} E{e} F900
        {% else %}
            G1 Z{zhop * -1} F900
        {% endif %}

        # Back to the exact saved path point and resume
        RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=60
        BASE_RESUME
    {% endif %}




[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    # Restore normal idle timeout
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}

    # ----------------------------------------------------
    # 1. Stop dynamic systems immediately (DPA + DFA)
    # ----------------------------------------------------
    DPA_OFF
    DFA_OFF
    UPDATE_DELAYED_GCODE ID=DPA_LOOP DURATION=0
    UPDATE_DELAYED_GCODE ID=DFA_LOOP DURATION=0

    # Reset pressure advance + flow to safe values
    SET_PRESSURE_ADVANCE ADVANCE=0
    M221 S100

    # ----------------------------------------------------
    # 2. Disable filament sensors (motion + switch)
    # ----------------------------------------------------
    SFS_DISABLE

    # ----------------------------------------------------
    # 3. Standard print-cancel behaviour
    # ----------------------------------------------------
    CLEAR_PAUSE
    END_PRINT                 ; your existing macro

    # ----------------------------------------------------
    # 4. Run Klipper's built-in cancel last (required)
    # ----------------------------------------------------
    BASE_CANCEL_PRINT




[gcode_macro UNLOAD_FILAMENT]
description: Hot unload with staged retract and clean state handling
gcode:
  {% set temp              = params.TEMP|default(220)|int %}
  {% set unload_distance   = params.UNLOAD_DISTANCE|default(100)|int %}
  {% set unload_speed_fast = params.UNLOAD_SPEED|default(900)|int %}

  SAVE_GCODE_STATE NAME=UNLOAD_STATE
  M117 Unloading filament…

  # ----------------------------------------------------
  # Disable filament sensors (prevents false runout)
  # ----------------------------------------------------
  SFS_DISABLE

  # ----------------------------------------------------
  # Heat to safe extrusion temp
  # ----------------------------------------------------
  {% set min_ok = printer.configfile.settings.extruder.min_extrude_temp|int %}
  {% set target = (temp if temp >= min_ok else min_ok) %}
  M104 S{target}
  M109 S{target}

  # ----------------------------------------------------
  # Perform unload sequence
  # ----------------------------------------------------
  G91
  M83
  G1 E2    F300                ; soften at nozzle
  G1 E-6   F1200               ; break the tip
  G1 E-{unload_distance} F{unload_speed_fast}
  G90

  # ----------------------------------------------------
  # Re-enable sensors
  # ----------------------------------------------------
  SFS_ENABLE

  RESTORE_GCODE_STATE NAME=UNLOAD_STATE
  M117 Filament unloaded



[gcode_macro M600]
description: Full filament change (park → unload → load → purge → resume)
gcode:
    # ------------------------------------------------------------------
    # CONFIGURABLE PARAMETERS (concrete defaults)
    # ------------------------------------------------------------------
    {% set zhop            = params.Z|default(10)|int %}
    {% set hold_temp       = params.HOLD|default(185)|int %}
    {% set unload_dist     = params.UNLOAD_DISTANCE|default(100)|int %}
    {% set load_dist       = params.LOAD_DISTANCE|default(90)|int %}
    {% set purge_dist      = params.PURGE_DISTANCE|default(35)|int %}
    {% set purge_speed     = params.PURGE_SPEED|default(300)|int %}

    {% set park_x = (printer.toolhead.axis_maximum.x / 2)|int %}
    {% set park_y = (printer.toolhead.axis_minimum.y + 5)|int %}

    # ------------------------------------------------------------------
    # SNAPSHOT MACHINE STATE
    # ------------------------------------------------------------------
    SAVE_GCODE_STATE NAME=FILCHANGE_STATE

    {% set extr = printer.toolhead.extruder %}
    {% set previous_target = printer[extr].target|int %}
    {% set min_ok = printer.configfile.settings.extruder.min_extrude_temp|int %}
    {% set hold = (hold_temp if hold_temp >= min_ok else min_ok) %}

    # ------------------------------------------------------------------
    # SAFETY: PAUSE DPA/DFA + CLEAR SLIP
    # ------------------------------------------------------------------
    DPA_OFF
    DFA_OFF
    SAVE_VARIABLE VARIABLE=last_slip VALUE=0

    # ------------------------------------------------------------------
    # PARK HEAD WITH SAFE Z-HOP
    # ------------------------------------------------------------------
    G91
    {% if (printer.gcode_move.position.z + zhop) < printer.toolhead.axis_maximum.z %}
        G1 Z{zhop} F1200
    {% endif %}
    G90
    G1 X{park_x} Y{park_y} F6000

    # ------------------------------------------------------------------
    # HEAT HOTEND TO SAFE HOLD TEMP
    # ------------------------------------------------------------------
    M104 S{hold}
    M109 S{hold}

    # ------------------------------------------------------------------
    # DISABLE ALL FILAMENT SENSORS
    # ------------------------------------------------------------------
    _FS_OFF

    # ------------------------------------------------------------------
    # RAW MANUAL UNLOAD (no recursion into unload macro)
    # ------------------------------------------------------------------
    M117 Unloading…
    G91
    M83
    G1 E2 F300             ; soften
    G1 E-6 F1200           ; break tip
    G1 E-{unload_dist} F900
    G90

    # ------------------------------------------------------------------
    # WAIT FOR USER TO INSERT FILAMENT
    # ------------------------------------------------------------------
    M117 Insert filament and click RESUME
    PAUSE

    # ------------------------------------------------------------------
    # RAW MANUAL LOAD + PURGE (no recursion into load macro)
    # ------------------------------------------------------------------
    M117 Loading…
    G91
    M83
    G1 E2 F300
    G1 E{load_dist} F600
    G1 E{purge_dist} F{purge_speed}
    G1 E-1 F1500
    G90

    # ------------------------------------------------------------------
    # RE-ENABLE FILAMENT SENSORS
    # ------------------------------------------------------------------
    _FS_ON

    # ------------------------------------------------------------------
    # RESTORE PREVIOUS HOTEND TEMP
    # ------------------------------------------------------------------
    {% if previous_target > 0 %}
        M109 S{previous_target}
    {% endif %}

    # ------------------------------------------------------------------
    # PRIME + DESTING BEFORE RESUMING
    # ------------------------------------------------------------------
    G91
    M83
    {% if printer[extr].temperature >= min_ok %}
        G1 E2 F900
        G1 E-0.5 F1800
    {% endif %}
    G90

    # ------------------------------------------------------------------
    # RESTORE MACHINE STATE & RESUME PRINT
    # ------------------------------------------------------------------
    RESTORE_GCODE_STATE NAME=FILCHANGE_STATE
    M117 Filament change complete


[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
# number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
# keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
# timeout: 600
#    This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
# max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
# dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.