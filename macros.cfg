[gcode_macro PRINT_START]
gcode:
  ###################################################################
  # PRINT_START (Updated with Dynamic PA/Flow integration)
  ###################################################################
# ===================================================================
  #   ACTIVE CONTROL CONFIGURATION
  # ===================================================================

  # ... [Existing DPA/DFA configs] ...

  # ----------------------------------------------------
  # NEW: Auto-Temp Logic
  # ----------------------------------------------------
  {% if material == "PLA" %}
      # ... DPA/DFA configs ...
      SAVE_VARIABLE VARIABLE=material_viscosity_k VALUE=0.5   ; Low Boost
      
  {% elif material == "PETG" %}
      # ...
      SAVE_VARIABLE VARIABLE=material_viscosity_k VALUE=1.2   ; High Boost!

  {% elif material == "ABS" or material == "ASA" %}
      # ...
      SAVE_VARIABLE VARIABLE=material_viscosity_k VALUE=0.8   ; Medium Boost
  {% endif %}
  # ---- 1. Reset Dynamic Systems (Safety First) ----
  DPA_OFF
  DFA_OFF
  AT_ENABLE
  
  # ---- 2. Get Parameters ----
  {% set target_bed       = params.BED|default(60)|int %}
  {% set target_extruder  = params.EXTRUDER|default(200)|int %}
  {% set material         = params.MATERIAL|default("PLA")|string %}

  # ---- Geometry helpers ----
  {% set x_max   = printer.toolhead.axis_maximum.x|float %}
  {% set y_max   = printer.toolhead.axis_maximum.y|float %}
  {% set x_min   = printer.toolhead.axis_minimum.x|float %}
  {% set y_min   = printer.toolhead.axis_minimum.y|float %}
  {% set x_mid   = (x_max + x_min) / 2.0 %}
  {% set y_mid   = (y_max + y_min) / 2.0 %}

  # ---- Purge line tuning ----
  {% set purge_len     = 220 %}
  {% set purge_z       = 0.30 %}
  {% set front_margin  = 5 %}
  {% set nozzle_soak   = 120 %}

  M117 Heating bed…
  M140 S{target_bed}
  M104 S{nozzle_soak}

  # ---- CONDITIONAL HOME ONLY ----
  _CG28

  # Safe location after homing
  G90
  G1 Z20 F9000
  G1 X{x_mid} Y{y_mid} F12000

  # ---- Final bed temp + expansion settle ----
  M190 S{target_bed}
  TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={target_bed-1} MAXIMUM={target_bed+3}

  # ---- QGL (full gantry leveling) ----
  M117 QGL…
  G90
  G1 Z20 F9000
  G1 X{x_mid} Y{y_mid} F12000
  QUAD_GANTRY_LEVEL
  # =========================================================
  # ADD THIS LINE HERE:
  # Re-home Z to match the new gantry level
  # =========================================================
  G28 Z

  G90
  G1 Z20 F9000
  G1 X{x_mid} Y{y_mid} F12000

  # ---- Eddy RAPID_SCAN adaptive mesh ----
  M117 Eddy mesh…
  BED_MESH_CLEAR
  BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=1

  # Move clear of probe area
  G90
  G1 X{x_mid} Y{y_mid} Z10 F12000

  # ---- Heat hotend to print temp ----
  M117 Heating hotend…
  M109 S{target_extruder}

  # ---- Wait for safe extrude temp ----
  {% set min_ok = printer.configfile.settings.extruder.min_extrude_temp|int %}
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_ok}

  # ===================================================================
  #   ACTIVE FLOW CONTROL CONFIGURATION
  # ===================================================================
  M117 Config Flow Control...

  # 1. Enable the Smart Sensor (Must be on for DPA/DFA to work)
  SFS_ENABLE 

  # 2. Configure Limits based on Material
  {% if material == "PLA" %}
      DPA_CONFIG MIN=0.01 MAX=0.08 GAIN=0.005 DAMP=0.85
      DFA_CONFIG MIN=0.95 MAX=1.05 GAIN=0.010 DAMP=0.70
      
  {% elif material == "PETG" %}
      # PETG allows higher PA max
      DPA_CONFIG MIN=0.02 MAX=0.15 GAIN=0.006 DAMP=0.85
      DFA_CONFIG MIN=0.95 MAX=1.10 GAIN=0.012 DAMP=0.70

  {% elif material == "ABS" or material == "ASA" %}
      DPA_CONFIG MIN=0.02 MAX=0.10 GAIN=0.005 DAMP=0.85
      DFA_CONFIG MIN=0.95 MAX=1.08 GAIN=0.010 DAMP=0.70
      
  {% else %}
      # Unknown material defaults
      DPA_CONFIG MIN=0.02 MAX=0.10 GAIN=0.005 DAMP=0.85
      DFA_CONFIG MIN=0.95 MAX=1.05 GAIN=0.010 DAMP=0.70
  {% endif %}

  # 3. Reset Flow Baseline to 1.0 (Safety)
  DFA_SET_BASE FLOW=1.0

  # 4. Turn Systems ON (This loads the PA from your Auto-Calibrate file)
  DPA_ON
  DFA_ON
  
  M117 Active Control ON...

  # ===================================================================
  #   PURGE & PRINT
  # ===================================================================

  M117 Purge lines…
  SAVE_GCODE_STATE NAME=PRIMELINE
  G90
  G92 E0

  G1 X{ (x_min + 30) if (x_min + 30) > 30 else 30 } Y{y_min + front_margin} Z{purge_z} F12000

  G91
  G1 X{purge_len}   E18 F1200
  G1 Y1             F6000
  G1 X-{purge_len}  E9  F1200
  G90
  G92 E0
  RESTORE_GCODE_STATE NAME=PRIMELINE

  # ---- Move back to center ----
  G90
  G1 X{x_mid} Y{y_mid} F12000

  # Note: _FS_ON removed because SFS_ENABLE was called earlier
  M117 Printing…


[gcode_macro PRINT_END]
gcode:
    # 1. Disable Active Control Systems IMMEDIATELY
    AT_DISABLE 
    DPA_OFF
    DFA_OFF
    SFS_DISABLE

    # 2. Get Boundaries
    {% set max_x = printer.toolhead.axis_maximum.x|float %}
    {% set max_y = printer.toolhead.axis_maximum.y|float %}
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    
    # 3. Check current Z
    {% set act_z = printer.toolhead.position.z|float %}
    {% if act_z < (max_z - 20) %}
        {% set z_safe = 20.0 %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}
    
    # 4. Retract and Raise Z
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-10.0 F3600                ; retract filament
    G91                            ; relative positioning
    G0 Z{z_safe} F3600             ; move nozzle up
    G90                            ; absolute positioning
    
    # 5. Park (Back Right)
    G0 X{max_x - 10} Y{max_y - 10} F12000
    
    # 6. Turn off heaters and fan
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    
    # 7. Disable steppers (except Z)
    M84 X Y E
    
    M117 Print Complete.



[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: BASE_CANCEL_PRINT
gcode:
    # Disable Active Control
    AT_DISABLE
    DPA_OFF
    DFA_OFF
    SFS_DISABLE

    # Execute standard cancel
    TURN_OFF_HEATERS
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    
    # Park Toolhead (Reuse PRINT_END logic logic usually, but here is a safe lift)
    G91
    G1 Z10 F3000
    G90
    G1 X{printer.toolhead.axis_maximum.x - 10} Y{printer.toolhead.axis_maximum.y - 10} F12000
    
    BASE_CANCEL_PRINT
    M117 Print Cancelled.



[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    # Disable sensor so loading filament doesn't trigger runout
    SFS_DISABLE
    
    {% set z = params.Z|default(10)|int %}
    
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    
    # Retract and Park
    G91
    G1 E-2 F2100
    G1 Z{z}
    G90
    # Park Front Center for easy access
    G1 X{printer.toolhead.axis_maximum.x / 2} Y10 F6000 
    
    M117 Paused.

[gcode_macro RESUME]
rename_existing: BASE_RESUME
gcode:
    # Re-enable sensor
    SFS_ENABLE
    
    # Note: We do NOT re-enable DPA/DFA here explicitly. 
    # They should stay in their previous state (ON), but paused.
    
    RESTORE_GCODE_STATE NAME=PAUSE_state
    G90
    BASE_RESUME
    M117 Printing...


[gcode_macro M600]
description: Color Change
gcode:
    PAUSE
    M117 Color Change: Unload, Load, then RESUME



[gcode_macro UNLOAD_FILAMENT]
description: Unloads filament (unsafe, use when hot)
gcode:
    SAVE_GCODE_STATE NAME=unload_state
    G91
    M117 Unloading...
    G1 E5 F300      ; purge a little
    G1 E-80 F1000   ; retract fast to pull out of melt zone
    G1 E-50 F1000   ; retract rest
    RESTORE_GCODE_STATE NAME=unload_state
    M117 Unloaded.

[gcode_macro LOAD_FILAMENT]
description: Loads filament (unsafe, use when hot)
gcode:
    SAVE_GCODE_STATE NAME=load_state
    G91
    M117 Loading...
    G1 E50 F1000    ; feed fast
    G1 E50 F1000    ; feed fast
    G1 E30 F300     ; feed slow to nozzle
    G1 E10 F150     ; purge
    RESTORE_GCODE_STATE NAME=load_state
    M117 Loaded.

[delayed_gcode FLOW_SPY_LOOP]
gcode:
    # 1. Gather Data
    {% set vars = printer.save_variables.variables %}
    {% set slip = vars.last_slip|default(0)|float %}
    {% set peak = vars.slip_peak|default(0)|float %}
    # Get the ACTUAL live flow/PA from the printer, not just the file
    {% set flow = printer.gcode_move.extrude_factor * 100 %}
    {% set pa   = printer.extruder.pressure_advance %}

    # 2. Print to Console
    RESPOND MSG="[SPY] Slip: {slip|round(2)}% (Peak: {peak|round(2)}%) | Flow: {flow|round(1)}% | PA: {pa|round(4)}"

    # 3. Loop every 2 seconds
    UPDATE_DELAYED_GCODE ID=FLOW_SPY_LOOP DURATION=2

[gcode_macro FLOW_SPY_ON]
description: Turn on live logging of Flow/PA/Slip
gcode:
    RESPOND MSG="Flow Spy Enabled."
    UPDATE_DELAYED_GCODE ID=FLOW_SPY_LOOP DURATION=1

[gcode_macro FLOW_SPY_OFF]
description: Turn off live logging
gcode:
    UPDATE_DELAYED_GCODE ID=FLOW_SPY_LOOP DURATION=0
    RESPOND MSG="Flow Spy Disabled."

    