# ======================================================================
# DYNAMIC FLOW ADJUSTMENT (DFA) — Live Extrusion Flow Control
# Slip Unit: PERCENT (e.g., 3.2 = 3.2% under-extrusion)
# ======================================================================
# ==================================================================================================
#  FILAMENT TUNING PRESETS — Dynamic Pressure Advance (DPA) + Dynamic Flow Adjustment (DFA)
# ==================================================================================================
#
#  Add these blocks into Orca START G-code depending on filament:
#
#  PLA:
#     DPA_SET_BASE PA=0.040
#     DPA_CONFIG MIN=0.020 MAX=0.200 GAIN=0.008 DAMP=0.85
#     DPA_ON
#     DFA_SET_BASE FLOW=1.00
#     DFA_CONFIG MIN=0.90 MAX=1.12 GAIN=0.015 DAMP=0.70
#     DFA_ON
#
#  PETG:
#     DPA_SET_BASE PA=0.055
#     DPA_CONFIG MIN=0.020 MAX=0.200 GAIN=0.008 DAMP=0.85
#     DPA_ON
#     DFA_SET_BASE FLOW=0.97
#     DFA_CONFIG MIN=0.90 MAX=1.15 GAIN=0.015 DAMP=0.70
#     DFA_ON
#
#  ABS / ASA:
#     DPA_SET_BASE PA=0.065
#     DPA_CONFIG MIN=0.020 MAX=0.200 GAIN=0.008 DAMP=0.85
#     DPA_ON
#     DFA_SET_BASE FLOW=1.02
#     DFA_CONFIG MIN=0.92 MAX=1.18 GAIN=0.017 DAMP=0.75
#     DFA_ON
#
# ==================================================================================================


[save_variables]
filename: ~/printer_data/config/sfs_auto_flow_vars.cfg


# ----------------------------------------------------------------------
# CORE DFA ENGINE
# ----------------------------------------------------------------------
[gcode_macro _DFA_CORE]
description: Internal Dynamic Flow Adjustment Engine
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set base_flow = vars.base_flow|default(1.00)|float %}
    {% set min_flow  = vars.flow_min|default(0.90)|float %}
    {% set max_flow  = vars.flow_max|default(1.15)|float %}
    {% set gain      = vars.flow_gain|default(0.015)|float %}
    {% set damping   = vars.flow_damp|default(0.70)|float %}
    {% set slip      = vars.last_slip|default(0.0)|float %}

    {% if slip|abs < 0.5 %}
        {% set slip = 0 %}
    {% endif %}

    {% set delta = slip * gain %}
    {% set delta = delta * damping %}
    {% set new_flow = base_flow + (delta / 100.0) %}

    {% if new_flow < min_flow %}
        {% set new_flow = min_flow %}
    {% elif new_flow > max_flow %}
        {% set new_flow = max_flow %}
    {% endif %}

    SAVE_VARIABLE VARIABLE=current_flow VALUE={ new_flow }
    M221 S{ new_flow * 100 }

    RESPOND PREFIX="DFA" MSG="Slip={ slip|round(2) }%  Flow={ new_flow|round(4) }"


# ----------------------------------------------------------------------
# DFA LOOP
# ----------------------------------------------------------------------
[delayed_gcode DFA_LOOP]
initial_duration: 0.12
gcode:
    {% if printer.save_variables.variables.dfa_enabled|default(False) %}
        _DFA_CORE
        UPDATE_DELAYED_GCODE ID=DFA_LOOP DURATION=0.12
    {% endif %}


# ----------------------------------------------------------------------
# ENABLE DFA
# ----------------------------------------------------------------------
[gcode_macro DFA_ON]
description: Enable Dynamic Flow Adjustment
gcode:
    SAVE_VARIABLE VARIABLE=dfa_enabled VALUE=True
    RESPOND PREFIX="DFA" MSG="Dynamic Flow ENABLED (Live Slip Correction Active)"
    UPDATE_DELAYED_GCODE ID=DFA_LOOP DURATION=0.12


# ----------------------------------------------------------------------
# DISABLE DFA + RESTORE BASE FLOW
# ----------------------------------------------------------------------
[gcode_macro DFA_OFF]
description: Disable Dynamic Flow Adjustment
gcode:
    SAVE_VARIABLE VARIABLE=dfa_enabled VALUE=False

    {% set base_flow = printer.save_variables.variables.base_flow|default(1.0)|float %}
    M221 S{ base_flow * 100 }

    RESPOND PREFIX="DPA" MSG="PA restored to base={ base_pa }"



# ----------------------------------------------------------------------
# BASE FLOW PER FILAMENT
# ----------------------------------------------------------------------
[gcode_macro DFA_SET_BASE]
description: Define baseline flow multiplier
gcode:
    {% set f = params.FLOW|float %}
    SAVE_VARIABLE VARIABLE=base_flow VALUE={ f }
    RESPOND PREFIX="DFA" MSG="Base Flow Multiplier set to { f }"


# ----------------------------------------------------------------------
# DFA CONFIGURATION LIMITS
# ----------------------------------------------------------------------
[gcode_macro DFA_CONFIG]
description: Configure DFA min/max/gain/damp
gcode:
    {% if params.MIN %}
        SAVE_VARIABLE VARIABLE=flow_min VALUE={ params.MIN|float }
    {% endif %}
    {% if params.MAX %}
        SAVE_VARIABLE VARIABLE=flow_max VALUE={ params.MAX|float }
    {% endif %}
    {% if params.GAIN %}
        SAVE_VARIABLE VARIABLE=flow_gain VALUE={ params.GAIN|float }
    {% endif %}
    {% if params.DAMP %}
        SAVE_VARIABLE VARIABLE=flow_damp VALUE={ params.DAMP|float }
    {% endif %}

    RESPOND PREFIX="DFA" MSG="DFA Config: min={ printer.save_variables.variables.flow_min } max={ printer.save_variables.variables.flow_max } gain={ printer.save_variables.variables.flow_gain } damp={ printer.save_variables.variables.flow_damp }"
