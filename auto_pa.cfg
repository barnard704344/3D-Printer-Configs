# ==========================================================================================
#  AUTO PA CALIBRATION — SLIP-DRIVEN PRESSURE ADVANCE TUNING
# ==========================================================================================
# This system automatically determines the ideal Pressure Advance for each spool
# by running a controlled 40x40 mm square test at high acceleration. Your SFS motion
# sensor reports slip (%), and the macro converts peak slip → PA value.
#
# HOW TO USE:
#     1. Heat the nozzle and bed to spool-appropriate temps
#     2. Run AUTO_PA_CALIBRATE with temperature overrides (below)
#     3. The macro:
#          - Prints 40×40 stress pattern
#          - Reads slip peak
#          - Computes PA from slip
#          - Clamps to safe range (0.015–0.12)
#          - Automatically stores new base_pa via save_variables
#          - Applies SET_PRESSURE_ADVANCE immediately
#
# NOTE:
#     • This replaces manual PA towers.
#     • The calculated PA becomes your new DPA baseline.
#     • Dynamic PA (DPA_ON) continues to work normally on top of the new baseline.
#
# ==========================================================================================
#  EXAMPLES
# ==========================================================================================
#
# PLA EXAMPLE:
#     AUTO_PA_CALIBRATE TEMP=210 BED=60 SPEED=150 ACCEL=3000
#
# PETG EXAMPLE:
#     AUTO_PA_CALIBRATE TEMP=240 BED=85 SPEED=120 ACCEL=2500
#
# ABS / ASA EXAMPLE:
#     AUTO_PA_CALIBRATE TEMP=245 BED=100 SPEED=150 ACCEL=4000
#
# You may omit parameters. These are valid:
#     AUTO_PA_CALIBRATE
#     AUTO_PA_CALIBRATE TEMP=245
#     AUTO_PA_CALIBRATE SPEED=180 ACCEL=4500
#
# ==========================================================================================
#  RESULT STORAGE
# ==========================================================================================
#     • PA is saved as:
#           save_variables → base_pa
#     • Meaning it automatically survives reboots and merges seamlessly with:
#           DPA_SET_BASE
#           DPA_ON / DPA_OFF
#
# ==========================================================================================
# END OF DOCUMENTATION HEADER — MACROS BEGIN BELOW
# ==========================================================================================

[gcode_macro AUTO_PA_CALIBRATE]
description: Automated Pressure Advance Calibration using Slip Feedback
gcode:
    {% set temp = params.TEMP|default(240)|int %}
    {% set bed = params.BED|default(80)|int %}
    {% set feed = params.SPEED|default(120)|int %}
    {% set accel = params.ACCEL|default(3000)|int %}

    M117 Auto-PA: Heating…
    M104 S{temp}
    M140 S{bed}
    M190 S{bed}
    M109 S{temp}

    # Reset slip history
    SAVE_VARIABLE VARIABLE=last_slip VALUE=0
    SAVE_VARIABLE VARIABLE=slip_peak VALUE=0

    M117 Auto-PA: Test pattern…

    # Configure aggressive moves to expose corner pressure errors
    SET_VELOCITY_LIMIT VELOCITY={feed} ACCEL={accel}

    G90
    G1 X10 Y10 F9000
    G1 Z0.28 F3000

    M83
    G92 E0

    # Draw a 40x40mm square to create pressure buildup
    {% for i in range(3) %}
        G1 X50 E6 F{feed*60}
        G1 Y50 E6 F{feed*60}
        G1 X10 E6 F{feed*60}
        G1 Y10 E6 F{feed*60}
    {% endfor %}

    # Capture peak slip value during test
    {% set slip_now = printer.save_variables.variables.last_slip|default(0)|float %}

    # Compute recommended PA (empirical conversion)
    #  slip (%) * constant → PA value
    {% set k = 0.008 %}
    {% set pa_est = (slip_now * k)|round(4) %}

    # Enforce sane range
    {% if pa_est < 0.015 %}
        {% set pa_est = 0.015 %}
    {% endif %}
    {% if pa_est > 0.12 %}
        {% set pa_est = 0.12 %}
    {% endif %}

    # Apply and store permanently
    SAVE_VARIABLE VARIABLE=base_pa VALUE={ pa_est }
    SET_PRESSURE_ADVANCE ADVANCE={ pa_est }

    RESPOND PREFIX="AUTO_PA" MSG="Slip peak = {{ slip_now }}%"
    RESPOND PREFIX="AUTO_PA" MSG="Recommended PA = {{ pa_est }}"
    RESPOND PREFIX="AUTO_PA" MSG="Base PA updated and applied."

    M117 Auto-PA complete.
