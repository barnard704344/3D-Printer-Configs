[gcode_macro AUTO_PA_CALIBRATE]
description: Automated Pressure Advance Calibration using Slip Feedback
variable_k: 0.008
gcode:
    {% set temp = params.TEMP|default(240)|int %}
    {% set bed = params.BED|default(80)|int %}
    {% set feed = params.SPEED|default(120)|int %}
    {% set accel = params.ACCEL|default(3000)|int %}
    # -----------------------------
    # Required preparation
    # -----------------------------
    M117 Auto-PA: Homing...
    G28

    M117 Auto-PA: Gantry leveling...
    QUAD_GANTRY_LEVEL

    # Lift the toolhead for safety after QGL
    G90
    G1 Z10 F2400
    # -----------------------------
    # Heat bed FIRST (prevents ooze)
    # -----------------------------
    M117 Auto-PA: Heating bed...
    M140 S{bed}
    M190 S{bed}

    # -----------------------------
    # Heat nozzle SECOND
    # -----------------------------
    M117 Auto-PA: Heating nozzle...
    M104 S{temp}
    M109 S{temp}

    # -----------------------------
    # Reset slip history
    # -----------------------------
    SAVE_VARIABLE VARIABLE=last_slip VALUE=0
    SAVE_VARIABLE VARIABLE=slip_peak VALUE=0

    M117 Auto-PA: Test pattern…

    # -----------------------------
    # Aggressive move settings
    # -----------------------------
    SET_VELOCITY_LIMIT VELOCITY={feed} ACCEL={accel}

    G90
    G1 X10 Y10 F9000
    G1 Z0.28 F3000

    M83
    G92 E0

    # -----------------------------
    # Draw the 40x40 test pattern
    # -----------------------------
    {% for i in range(3) %}
        G1 X50 E6 F{feed*60}
        G1 Y50 E6 F{feed*60}
        G1 X10 E6 F{feed*60}
        G1 Y10 E6 F{feed*60}
    {% endfor %}

    # -----------------------------
    # Slip-based PA Calculation
    # -----------------------------
    {% set slip_now = printer.save_variables.variables.last_slip|default(0)|float %}
    {% set k = printer["gcode_macro AUTO_PA_CALIBRATE"].k|float %}
    {% set pa_est = (slip_now * k)|round(4) %}

    {% if pa_est < 0.015 %}
        {% set pa_est = 0.015 %}
    {% endif %}
    {% if pa_est > 0.12 %}
        {% set pa_est = 0.12 %}
    {% endif %}

    # Store + apply PA
    SAVE_VARIABLE VARIABLE=base_pa VALUE={pa_est}
    SET_PRESSURE_ADVANCE ADVANCE={pa_est}

    # -----------------------------
    # Report results cleanly
    # -----------------------------
    RESPOND PREFIX="AUTO_PA" MSG="Slip peak = {slip_now}"
    RESPOND PREFIX="AUTO_PA" MSG="Recommended PA = {pa_est}"
    RESPOND PREFIX="AUTO_PA" MSG="Base PA updated and applied."

    # -----------------------------
    # Cooldown and park sequence
    # -----------------------------
    M117 Cooling down…
    M104 S0
    M140 S0

    # Raise Z to clear the bed
    G90
    G1 Z20 F2400

    # Move toolhead to center
    G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} F9000

    RESPOND PREFIX="AUTO_PA" MSG="Calibration complete. Heaters off. Toolhead parked."
    M117 Auto-PA complete.


[gcode_macro AUTO_PA_UI]
description: Run Auto PA Calibration with parameters (no popup)
gcode:
    {% set temp = params.TEMP|default(240)|int %}
    {% set bed  = params.BED|default(80)|int %}
    {% set spd  = params.SPEED|default(120)|int %}
    {% set acc  = params.ACCEL|default(3000)|int %}

    RESPOND PREFIX="AUTO_PA" MSG="Starting Auto PA Calibration:"
    RESPOND PREFIX="AUTO_PA" MSG="TEMP={temp}, BED={bed}, SPEED={spd}, ACCEL={acc}"

    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd} ACCEL={acc}



[gcode_macro AUTO_PA_PLA]
gcode:
    SET_GCODE_VARIABLE MACRO=AUTO_PA_CALIBRATE VARIABLE=k VALUE=0.007
    AUTO_PA_UI TEMP=210 BED=60 SPEED=150 ACCEL=3000



[gcode_macro AUTO_PA_PETG_ADVANCED]
description: Dual-speed PA calibration for PETG (260 + 320 mm/s)
gcode:
    {% set temp  = 230 %}
    {% set bed   = 90 %}
    {% set spd1  = 260 %}
    {% set spd2  = 320 %}
    {% set acc   = 10000 %}
    {% set k     = printer["gcode_macro AUTO_PA_CALIBRATE"].k|default(0.008)|float %}

    # -------------------------
    # Heat bed FIRST
    # -------------------------
    RESPOND PREFIX="AUTO_PA" MSG="Heating bed to {bed}..."
    M140 S{bed}
    M190 S{bed}

    # Heat nozzle second
    RESPOND PREFIX="AUTO_PA" MSG="Heating nozzle to {temp}..."
    M104 S{temp}
    M109 S{temp}

    # -------------------------
    # Home + QGL
    # -------------------------
    RESPOND PREFIX="AUTO_PA" MSG="Homing printer..."
    G28

    RESPOND PREFIX="AUTO_PA" MSG="Running QGL..."
    QUAD_GANTRY_LEVEL
    G28 Z

    # -------------------------
    # Store original limits
    # -------------------------
    {% set orig_v = printer.toolhead.max_velocity %}
    {% set orig_a = printer.toolhead.max_accel %}

    SAVE_VARIABLE VARIABLE=orig_vel VALUE={orig_v}
    SAVE_VARIABLE VARIABLE=orig_accel VALUE={orig_a}

    SAVE_VARIABLE VARIABLE=last_slip VALUE=0

    # -------------------------
    # PASS 1 — 260 mm/s
    # -------------------------
    RESPOND PREFIX="AUTO_PA" MSG="Pass1 @ {spd1} mm/s"

    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd1} ACCEL={acc}

    {% set slip1 = printer.save_variables.variables.last_slip|default(0)|float %}
    {% set pa1 = (slip1 * k)|round(4) %}
    {% if pa1 < 0.015 %}{% set pa1 = 0.015 %}{% endif %}
    {% if pa1 > 0.12  %}{% set pa1 = 0.12  %}{% endif %}

    RESPOND PREFIX="AUTO_PA" MSG="Pass1 slip={slip1}%"
    RESPOND PREFIX="AUTO_PA" MSG="Pass1 PA={pa1}"

    SAVE_VARIABLE VARIABLE=last_slip VALUE=0

    # -------------------------
    # PASS 2 — 320 mm/s
    # -------------------------
    RESPOND PREFIX="AUTO_PA" MSG="Pass2 @ {spd2} mm/s"

    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd2} ACCEL={acc}

    {% set slip2 = printer.save_variables.variables.last_slip|default(0)|float %}
    {% set pa2 = (slip2 * k)|round(4) %}
    {% if pa2 < 0.015 %}{% set pa2 = 0.015 %}{% endif %}
    {% if pa2 > 0.12  %}{% set pa2 = 0.12  %}{% endif %}

    RESPOND PREFIX="AUTO_PA" MSG="Pass2 slip={slip2}%"
    RESPOND PREFIX="AUTO_PA" MSG="Pass2 PA={pa2}"

    # -------------------------
    # Average both PA results
    # -------------------------
    {% set pa_final = ((pa1 + pa2) / 2.0)|round(4) %}

    SAVE_VARIABLE VARIABLE=base_pa VALUE={pa_final}
    SET_PRESSURE_ADVANCE ADVANCE={pa_final}

    RESPOND PREFIX="AUTO_PA" MSG="Final PA={pa_final}"

    # -------------------------
    # Cooldown + Park
    # -------------------------
    M104 S0
    M140 S0
    G90
    G1 X175 Y175 Z20 F9000

    RESPOND PREFIX="AUTO_PA" MSG="Calibration complete. Heaters off. Toolhead parked."

    # -------------------------
    # Restore limits
    # -------------------------
    SET_VELOCITY_LIMIT VELOCITY={orig_v} ACCEL={orig_a}





[gcode_macro AUTO_PA_ABS]
gcode:
    SET_GCODE_VARIABLE MACRO=AUTO_PA_CALIBRATE VARIABLE=k VALUE=0.015
    AUTO_PA_UI TEMP=245 BED=100 SPEED=150 ACCEL=4000




