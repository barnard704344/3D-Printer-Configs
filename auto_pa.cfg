[gcode_macro AUTO_PA_CALIBRATE]
description: Automated Pressure Advance Calibration using Slip Feedback
variable_k: 0.008
gcode:
    {% set temp = params.TEMP|default(240)|int %}
    {% set bed = params.BED|default(80)|int %}
    {% set feed = params.SPEED|default(120)|int %}
    {% set accel = params.ACCEL|default(3000)|int %}
    
    # -----------------------------
    # Preparation
    # -----------------------------
    # Only Home if not homed
    {% if "xyz" not in printer.toolhead.homed_axes %}
        M117 Auto-PA: Homing...
        G28
        QUAD_GANTRY_LEVEL
        G28 Z
    {% endif %}

    # Move to start height
    G90
    G1 Z10 F2400

    M117 Auto-PA: Heating...
    M140 S{bed}
    M104 S{temp}
    M190 S{bed}
    M109 S{temp}

    # -----------------------------
    # RESET SLIP TELEMETRY
    # -----------------------------
    SFS_SLIP_RESET
    G4 P500 ; Wait 0.5s for reset to take effect

    # -----------------------------
    # Aggressive move settings
    # -----------------------------
    SET_VELOCITY_LIMIT VELOCITY={feed} ACCEL={accel}

    G90
    G1 X10 Y10 F9000
    G1 Z0.28 F3000

    M83
    G92 E0
    
    M117 Auto-PA: Pattern Start...

    # -----------------------------
    # Draw the 40x40 test pattern
    # -----------------------------
    {% for i in range(3) %}
        G1 X50 E6 F{feed*60}
        G1 Y50 E6 F{feed*60}
        G1 X10 E6 F{feed*60}
        G1 Y10 E6 F{feed*60}
    {% endfor %}

    # -----------------------------
    # CRITICAL WAIT COMMANDS
    # -----------------------------
    M400          ; Wait for all moves to finish physically
    G4 P1000      ; Wait 1 second for the Python script to write the final variable

    # -----------------------------
    # Slip-based PA Calculation
    # -----------------------------
    # WE MUST RELOAD THE VARIABLE HERE to get the new value
    {% set vars = printer.save_variables.variables %}
    {% set slip_now = vars.slip_peak|default(0)|float %}
    
    {% set k = printer["gcode_macro AUTO_PA_CALIBRATE"].k|float %}
    {% set pa_est = (slip_now * k)|round(4) %}

    # Clamp results
    {% if pa_est < 0.015 %}
        {% set pa_est = 0.015 %}
    {% endif %}
    {% if pa_est > 0.12 %}
        {% set pa_est = 0.12 %}
    {% endif %}

    # Store + apply PA
    SAVE_VARIABLE VARIABLE=base_pa VALUE={pa_est}
    SET_PRESSURE_ADVANCE ADVANCE={pa_est}

    # -----------------------------
    # Report results
    # -----------------------------
    RESPOND PREFIX="AUTO_PA" MSG="Peak Slip detected: {slip_now}%"
    RESPOND PREFIX="AUTO_PA" MSG="Calculated PA: {pa_est}"

    # NOTE: We do NOT cool down here anymore. The wrapper macro handles that.
    G90
    G1 Z10 F2400

[gcode_macro AUTO_PA_UI]
description: Run Auto PA Calibration with parameters (no popup)
gcode:
    {% set temp = params.TEMP|default(240)|int %}
    {% set bed  = params.BED|default(80)|int %}
    {% set spd  = params.SPEED|default(120)|int %}
    {% set acc  = params.ACCEL|default(3000)|int %}

    RESPOND PREFIX="AUTO_PA" MSG="Starting Auto PA Calibration:"
    RESPOND PREFIX="AUTO_PA" MSG="TEMP={temp}, BED={bed}, SPEED={spd}, ACCEL={acc}"

    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd} ACCEL={acc}
    
    # UI Wrapper handles cooldown
    M104 S0
    M140 S0
    G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} F9000
    M117 Auto-PA complete.


[gcode_macro AUTO_PA_PLA]
gcode:
    SET_GCODE_VARIABLE MACRO=AUTO_PA_CALIBRATE VARIABLE=k VALUE=0.007
    AUTO_PA_UI TEMP=210 BED=60 SPEED=150 ACCEL=3000


[gcode_macro AUTO_PA_PETG_ADVANCED]
description: Dual-speed PA calibration for PETG (260 + 320 mm/s)
gcode:
    {% set temp  = 230 %}
    {% set bed   = 90 %}
    {% set spd1  = 260 %}
    {% set spd2  = 320 %}
    {% set acc   = 10000 %}
    {% set k     = printer["gcode_macro AUTO_PA_CALIBRATE"].k|default(0.008)|float %}

    # 1. Heat Up
    M140 S{bed}
    M190 S{bed}
    M104 S{temp}
    M109 S{temp}
    
    # 2. Home & Level
    G28
    QUAD_GANTRY_LEVEL
    G28 Z

    # 3. Store Limits
    {% set orig_v = printer.toolhead.max_velocity %}
    {% set orig_a = printer.toolhead.max_accel %}

    # 4. Purge Line
    G90
    G1 X5 Y5 Z0.3 F3000
    G1 X50 E10 F600
    G1 Z2 F3000

    # -------------------------
    # PASS 1 — 260 mm/s
    # -------------------------
    RESPOND PREFIX="AUTO_PA" MSG="Pass 1: {spd1}mm/s"
    
    # Set K variable
    SET_GCODE_VARIABLE MACRO=AUTO_PA_CALIBRATE VARIABLE=k VALUE={k}
    
    # Run Calibration
    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd1} ACCEL={acc}

    # Retrieve Result 1
    {% set pa1 = printer.save_variables.variables.base_pa|float %}
    RESPOND PREFIX="AUTO_PA" MSG="Pass 1 Result: {pa1}"

    # -------------------------
    # PASS 2 — 320 mm/s
    # -------------------------
    RESPOND PREFIX="AUTO_PA" MSG="Pass 2: {spd2}mm/s"
    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd2} ACCEL={acc}

    # Retrieve Result 2
    {% set pa2 = printer.save_variables.variables.base_pa|float %}
    RESPOND PREFIX="AUTO_PA" MSG="Pass 2 Result: {pa2}"

    # -------------------------
    # Average & Save
    # -------------------------
    {% set pa_final = ((pa1 + pa2) / 2.0)|round(4) %}

    SAVE_VARIABLE VARIABLE=base_pa VALUE={pa_final}
    SET_PRESSURE_ADVANCE ADVANCE={pa_final}
    
    RESPOND PREFIX="AUTO_PA" MSG="FINAL CALCULATED PA: {pa_final}"

    # -------------------------
    # Cooldown + Park
    # -------------------------
    M104 S0
    M140 S0
    G90
    G1 Z20 F2400
    G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} F9000
    
    # Restore Limits
    SET_VELOCITY_LIMIT VELOCITY={orig_v} ACCEL={orig_a}
    
    RESPOND PREFIX="AUTO_PA" MSG="Calibration complete. Heaters off. Toolhead parked."


[gcode_macro AUTO_PA_ABS]
gcode:
    SET_GCODE_VARIABLE MACRO=AUTO_PA_CALIBRATE VARIABLE=k VALUE=0.015
    AUTO_PA_UI TEMP=245 BED=100 SPEED=150 ACCEL=4000