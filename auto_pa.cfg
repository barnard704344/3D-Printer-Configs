[gcode_macro AUTO_PA_CALIBRATE]
description: Automated Pressure Advance Calibration
variable_k: 0.008
gcode:
    {% set temp = params.TEMP|default(240)|int %}
    {% set bed = params.BED|default(80)|int %}
    {% set feed = params.SPEED|default(100)|int %}
    {% set accel = params.ACCEL|default(3000)|int %}
    
    # Setup
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
        QUAD_GANTRY_LEVEL
        G28 Z
    {% endif %}

    G90
    G1 Z10 F2400
    M140 S{bed}
    M104 S{temp}
    M190 S{bed}
    M109 S{temp}

    # Reset Telemetry
    SFS_SLIP_RESET
    G4 P500

    # Settings
    SET_VELOCITY_LIMIT VELOCITY={feed} ACCEL={accel}

    # Move to start
    G90
    G1 X10 Y10 F9000
    G1 Z0.28 F3000
    M83
    G92 E0
    
    # -----------------------------------------------------------
    # THE FIX: Extrude 1.5mm (Normal Line), NOT 6mm (Blob)
    # -----------------------------------------------------------
    {% for i in range(3) %}
        G1 X50 E1.5 F{feed*60}
        G1 Y50 E1.5 F{feed*60}
        G1 X10 E1.5 F{feed*60}
        G1 Y10 E1.5 F{feed*60}
    {% endfor %}

    # Wait for completion
    M400
    G4 P1000

    # Calculate
    {% set vars = printer.save_variables.variables %}
    {% set slip_now = vars.slip_peak|default(0)|float %}
    {% set k = printer["gcode_macro AUTO_PA_CALIBRATE"].k|float %}
    {% set pa_est = (slip_now * k)|round(4) %}

    # Clamp (PETG PA is usually 0.03 - 0.06)
    {% if pa_est < 0.02 %} {% set pa_est = 0.02 %} {% endif %}
    {% if pa_est > 0.12 %} {% set pa_est = 0.12 %} {% endif %}

    # Save
    SAVE_VARIABLE VARIABLE=base_pa VALUE={pa_est}
    SET_PRESSURE_ADVANCE ADVANCE={pa_est}

    RESPOND PREFIX="AUTO_PA" MSG="Peak Slip: {slip_now}% -> Calculated PA: {pa_est}"

    G90
    G1 Z10 F2400


    
[gcode_macro AUTO_PA_UI]
description: Run Auto PA Calibration with parameters (no popup)
gcode:
    {% set temp = params.TEMP|default(240)|int %}
    {% set bed  = params.BED|default(80)|int %}
    {% set spd  = params.SPEED|default(120)|int %}
    {% set acc  = params.ACCEL|default(3000)|int %}

    RESPOND PREFIX="AUTO_PA" MSG="Starting Auto PA Calibration:"
    RESPOND PREFIX="AUTO_PA" MSG="TEMP={temp}, BED={bed}, SPEED={spd}, ACCEL={acc}"

    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd} ACCEL={acc}
    
    # UI Wrapper handles cooldown
    M104 S0
    M140 S0
    G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} F9000
    M117 Auto-PA complete.


[gcode_macro AUTO_PA_PLA]
description: Speed/Accel PA calibration for PLA
gcode:
    {% set temp  = 215 %}
    {% set bed   = 60 %}
    
    # PLA flows well. We can test slightly faster.
    # 150mm/s = ~12mm3/s | 200mm/s = ~16mm3/s
    {% set spd1  = 150 %}
    {% set spd2  = 200 %}
    {% set acc   = 6000 %} 
    
    # PLA is stiff, slip is lower. 
    # K-factor converts small slip into PA.
    {% set k     = 0.012 %}

    # 1. Heat Up
    M140 S{bed}
    M190 S{bed}
    M104 S{temp}
    M109 S{temp}
    
    # 2. Home & Level
    G28
    QUAD_GANTRY_LEVEL
    G28 Z

    # 3. Store Limits
    {% set orig_v = printer.toolhead.max_velocity %}
    {% set orig_a = printer.toolhead.max_accel %}

    # 4. Purge Line
    G90
    G1 X5 Y5 Z0.3 F3000
    G1 X50 E10 F600
    G1 Z2 F3000

    # -------------------------
    # PASS 1 — 150 mm/s
    # -------------------------
    RESPOND PREFIX="AUTO_PA" MSG="PLA Pass 1: {spd1}mm/s"
    SET_GCODE_VARIABLE MACRO=AUTO_PA_CALIBRATE VARIABLE=k VALUE={k}
    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd1} ACCEL={acc}
    {% set pa1 = printer.save_variables.variables.base_pa|float %}

    # -------------------------
    # PASS 2 — 200 mm/s
    # -------------------------
    RESPOND PREFIX="AUTO_PA" MSG="PLA Pass 2: {spd2}mm/s"
    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd2} ACCEL={acc}
    {% set pa2 = printer.save_variables.variables.base_pa|float %}

    # -------------------------
    # Average & Save
    # -------------------------
    {% set pa_final = ((pa1 + pa2) / 2.0)|round(4) %}
    SAVE_VARIABLE VARIABLE=base_pa VALUE={pa_final}
    SET_PRESSURE_ADVANCE ADVANCE={pa_final}
    
    RESPOND PREFIX="AUTO_PA" MSG="PLA CALIBRATED PA: {pa_final}"

    # -------------------------
    # Finish
    # -------------------------
    M104 S0
    M140 S0
    G90
    G1 Z20 F2400
    G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} F9000
    SET_VELOCITY_LIMIT VELOCITY={orig_v} ACCEL={orig_a}


    


[gcode_macro AUTO_PA_PETG_ADVANCED]
description: Realistic speed PA calibration for PETG
gcode:
    {% set temp  = 240 %}  # Bumped temp slightly for flow
    {% set bed   = 80 %}
    
    # REASONABLE SPEEDS FOR PETG
    {% set spd1  = 100 %}  
    {% set spd2  = 150 %}
    
    # High Accel tests PA better than high speed
    {% set acc   = 5000 %} 
    
    # Tuned K-factor for PETG
    {% set k     = 0.015 %}

    # 1. Heat Up
    M140 S{bed}
    M190 S{bed}
    M104 S{temp}
    M109 S{temp}
    
    # 2. Home & Level
    G28
    QUAD_GANTRY_LEVEL
    G28 Z

    # 3. Store Limits
    {% set orig_v = printer.toolhead.max_velocity %}
    {% set orig_a = printer.toolhead.max_accel %}

    # 4. Purge Line
    G90
    G1 X5 Y5 Z0.3 F3000
    G1 X50 E10 F600
    G1 Z2 F3000

    # -------------------------
    # PASS 1 — 100 mm/s
    # -------------------------
    RESPOND PREFIX="AUTO_PA" MSG="Pass 1: {spd1}mm/s"
    SET_GCODE_VARIABLE MACRO=AUTO_PA_CALIBRATE VARIABLE=k VALUE={k}
    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd1} ACCEL={acc}
    {% set pa1 = printer.save_variables.variables.base_pa|float %}

    # -------------------------
    # PASS 2 — 150 mm/s
    # -------------------------
    RESPOND PREFIX="AUTO_PA" MSG="Pass 2: {spd2}mm/s"
    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd2} ACCEL={acc}
    {% set pa2 = printer.save_variables.variables.base_pa|float %}

    # -------------------------
    # Average & Save
    # -------------------------
    {% set pa_final = ((pa1 + pa2) / 2.0)|round(4) %}

    SAVE_VARIABLE VARIABLE=base_pa VALUE={pa_final}
    SET_PRESSURE_ADVANCE ADVANCE={pa_final}
    
    RESPOND PREFIX="AUTO_PA" MSG="FINAL CALCULATED PA: {pa_final}"

    # -------------------------
    # Finish
    # -------------------------
    M104 S0
    M140 S0
    G90
    G1 Z20 F2400
    G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} F9000
    
    SET_VELOCITY_LIMIT VELOCITY={orig_v} ACCEL={orig_a}


[gcode_macro AUTO_PA_ABS]
description: Speed/Accel PA calibration for ABS/ASA
gcode:
    {% set temp  = 250 %}
    {% set bed   = 105 %}
    
    # ABS flows okay at high temp, but keep it safe.
    # 120mm/s = ~10mm3/s | 180mm/s = ~14.5mm3/s
    {% set spd1  = 120 %}
    {% set spd2  = 180 %}
    {% set acc   = 5000 %} 
    
    # ABS is softer. PA is usually slightly higher than PLA.
    {% set k     = 0.010 %}

    # 1. Heat Up (Bed takes a while)
    M140 S{bed}
    M190 S{bed}
    M104 S{temp}
    M109 S{temp}
    
    # 2. Home & Level
    G28
    QUAD_GANTRY_LEVEL
    G28 Z

    # 3. Store Limits
    {% set orig_v = printer.toolhead.max_velocity %}
    {% set orig_a = printer.toolhead.max_accel %}

    # 4. Purge Line
    G90
    G1 X5 Y5 Z0.3 F3000
    G1 X50 E10 F600
    G1 Z2 F3000

    # -------------------------
    # PASS 1 — 120 mm/s
    # -------------------------
    RESPOND PREFIX="AUTO_PA" MSG="ABS Pass 1: {spd1}mm/s"
    SET_GCODE_VARIABLE MACRO=AUTO_PA_CALIBRATE VARIABLE=k VALUE={k}
    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd1} ACCEL={acc}
    {% set pa1 = printer.save_variables.variables.base_pa|float %}

    # -------------------------
    # PASS 2 — 180 mm/s
    # -------------------------
    RESPOND PREFIX="AUTO_PA" MSG="ABS Pass 2: {spd2}mm/s"
    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd2} ACCEL={acc}
    {% set pa2 = printer.save_variables.variables.base_pa|float %}

    # -------------------------
    # Average & Save
    # -------------------------
    {% set pa_final = ((pa1 + pa2) / 2.0)|round(4) %}
    SAVE_VARIABLE VARIABLE=base_pa VALUE={pa_final}
    SET_PRESSURE_ADVANCE ADVANCE={pa_final}
    
    RESPOND PREFIX="AUTO_PA" MSG="ABS CALIBRATED PA: {pa_final}"

    # -------------------------
    # Finish
    # -------------------------
    M104 S0
    M140 S0
    G90
    G1 Z20 F2400
    G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} F9000
    SET_VELOCITY_LIMIT VELOCITY={orig_v} ACCEL={orig_a}