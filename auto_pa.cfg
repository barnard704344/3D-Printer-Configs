[gcode_macro AUTO_PA_CALIBRATE]
description: Automated Pressure Advance Calibration using Slip Feedback
gcode:
    {% set temp = params.TEMP|default(240)|int %}
    {% set bed = params.BED|default(80)|int %}
    {% set feed = params.SPEED|default(120)|int %}
    {% set accel = params.ACCEL|default(3000)|int %}
    # -----------------------------
    # Required preparation
    # -----------------------------
    M117 Auto-PA: Homing...
    G28

    M117 Auto-PA: Gantry leveling...
    QUAD_GANTRY_LEVEL

    # Lift the toolhead for safety after QGL
    G90
    G1 Z10 F2400
    # -----------------------------
    # Heat bed FIRST (prevents ooze)
    # -----------------------------
    M117 Auto-PA: Heating bed...
    M140 S{bed}
    M190 S{bed}

    # -----------------------------
    # Heat nozzle SECOND
    # -----------------------------
    M117 Auto-PA: Heating nozzle...
    M104 S{temp}
    M109 S{temp}

    # -----------------------------
    # Reset slip history
    # -----------------------------
    SAVE_VARIABLE VARIABLE=last_slip VALUE=0
    SAVE_VARIABLE VARIABLE=slip_peak VALUE=0

    M117 Auto-PA: Test pattern…

    # -----------------------------
    # Aggressive move settings
    # -----------------------------
    SET_VELOCITY_LIMIT VELOCITY={feed} ACCEL={accel}

    G90
    G1 X10 Y10 F9000
    G1 Z0.28 F3000

    M83
    G92 E0

    # -----------------------------
    # Draw the 40x40 test pattern
    # -----------------------------
    {% for i in range(3) %}
        G1 X50 E6 F{feed*60}
        G1 Y50 E6 F{feed*60}
        G1 X10 E6 F{feed*60}
        G1 Y10 E6 F{feed*60}
    {% endfor %}

    # -----------------------------
    # Slip-based PA Calculation
    # -----------------------------
    {% set slip_now = printer.save_variables.variables.last_slip|default(0)|float %}
    {% set k = 0.008 %}
    {% set pa_est = (slip_now * k)|round(4) %}

    {% if pa_est < 0.015 %}
        {% set pa_est = 0.015 %}
    {% endif %}
    {% if pa_est > 0.12 %}
        {% set pa_est = 0.12 %}
    {% endif %}

    # Store + apply PA
    SAVE_VARIABLE VARIABLE=base_pa VALUE={pa_est}
    SET_PRESSURE_ADVANCE ADVANCE={pa_est}

    # -----------------------------
    # Report results cleanly
    # -----------------------------
    RESPOND PREFIX="AUTO_PA" MSG="Slip peak = {slip_now}"
    RESPOND PREFIX="AUTO_PA" MSG="Recommended PA = {pa_est}"
    RESPOND PREFIX="AUTO_PA" MSG="Base PA updated and applied."

    # -----------------------------
    # Cooldown and park sequence
    # -----------------------------
    M117 Cooling down…
    M104 S0
    M140 S0

    # Raise Z to clear the bed
    G90
    G1 Z20 F2400

    # Move toolhead to center
    G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} F9000

    RESPOND PREFIX="AUTO_PA" MSG="Calibration complete. Heaters off. Toolhead parked."
    M117 Auto-PA complete.


[gcode_macro AUTO_PA_UI]
description: Run Auto PA Calibration with parameters (no popup)
gcode:
    {% set temp = params.TEMP|default(240)|int %}
    {% set bed  = params.BED|default(80)|int %}
    {% set spd  = params.SPEED|default(120)|int %}
    {% set acc  = params.ACCEL|default(3000)|int %}

    RESPOND PREFIX="AUTO_PA" MSG="Starting Auto PA Calibration:"
    RESPOND PREFIX="AUTO_PA" MSG="TEMP={temp}, BED={bed}, SPEED={spd}, ACCEL={acc}"

    AUTO_PA_CALIBRATE TEMP={temp} BED={bed} SPEED={spd} ACCEL={acc}



[gcode_macro AUTO_PA_PLA]
description: Auto PA Calibration preset for PLA
gcode:
    AUTO_PA_UI TEMP=210 BED=60 SPEED=150 ACCEL=3000


[gcode_macro AUTO_PA_PETG]
description: Auto PA Calibration preset for PETG
gcode:
    AUTO_PA_UI TEMP=230 BED=80 SPEED=120 ACCEL=2500


[gcode_macro AUTO_PA_ABS]
description: Auto PA Calibration preset for ABS/ASA
gcode:
    AUTO_PA_UI TEMP=245 BED=100 SPEED=150 ACCEL=4000



