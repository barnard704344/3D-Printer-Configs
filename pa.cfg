# ======================================================================
#  DYNAMIC PRESSURE ADVANCE â€” FILAMENT PRESETS
# ======================================================================
# Add the following to your slicer START G-code depending on filament:
#
# PLA
#   DPA_SET_BASE PA=0.04
#   DPA_CONFIG MIN=0.02 MAX=0.20 GAIN=0.008 DAMP=0.85
#   DPA_ON
#
# PETG
#   DPA_SET_BASE PA=0.055
#   DPA_CONFIG MIN=0.02 MAX=0.20 GAIN=0.008 DAMP=0.85
#   DPA_ON
#
# ABS / ASA
#   DPA_SET_BASE PA=0.065
#   DPA_CONFIG MIN=0.02 MAX=0.20 GAIN=0.008 DAMP=0.85
#   DPA_ON
#
# ======================================================================


[save_variables]
filename: ~/printer_data/config/sfs_auto_flow_vars.cfg


[gcode_macro _DPA_CORE]
description: Internal Dynamic Pressure Advance Engine (Optimized)
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set base_pa = vars.base_pa|default(0.04)|float %}
    {% set min_pa  = vars.pa_min|default(0.02)|float %}
    {% set max_pa  = vars.pa_max|default(0.20)|float %}
    {% set dpa_gain = vars.pa_gain|default(0.008)|float %}
    {% set damping  = vars.pa_damp|default(0.85)|float %}
    {% set slip = vars.last_slip|default(0)|float %}
    
    # Get current PA setting from Klipper (not just the file)
    {% set current_real_pa = printer.extruder.pressure_advance %}

    # Compute adjustment
    {% set delta = slip * dpa_gain %}
    {% set delta = delta * damping %}
    {% set new_pa = base_pa + delta %}

    # Clamp limits
    {% if new_pa < min_pa %}
        {% set new_pa = min_pa %}
    {% elif new_pa > max_pa %}
        {% set new_pa = max_pa %}
    {% endif %}

    # ---------------------------------------------------------
    # OPTIMIZATION: Only apply if change is > 0.002
    # This prevents micro-stutters from constant updates
    # ---------------------------------------------------------
    {% if (new_pa - current_real_pa)|abs > 0.002 %}
        SAVE_VARIABLE VARIABLE=current_pa VALUE={ new_pa }
        SET_PRESSURE_ADVANCE ADVANCE={ new_pa }
        # Optional: Log only when changed to avoid console spam
        # RESPOND PREFIX="DPA" MSG="Slip={ slip|round(2) }%  PA Updated to { new_pa|round(4) }"
    {% endif %}

[delayed_gcode DPA_LOOP]
# Run every 0.5s instead of 0.12s to save CPU and reduce stutter
initial_duration: 0.5
gcode:
    {% if printer.save_variables.variables.dpa_enabled|default(False) %}
        _DPA_CORE
        UPDATE_DELAYED_GCODE ID=DPA_LOOP DURATION=0.5
    {% endif %}



[delayed_gcode DPA_LOOP]
initial_duration: 0.12
gcode:
    {% if printer.save_variables.variables.dpa_enabled|default(False) %}
        _DPA_CORE
        UPDATE_DELAYED_GCODE ID=DPA_LOOP DURATION=0.12
    {% endif %}


[gcode_macro DPA_ON]
description: Enable Dynamic Pressure Advance System
gcode:
    SAVE_VARIABLE VARIABLE=dpa_enabled VALUE=True
    RESPOND PREFIX="DPA" MSG="Dynamic PA ENABLED"
    UPDATE_DELAYED_GCODE ID=DPA_LOOP DURATION=0.12


[gcode_macro DPA_CONFIG]
description: Configure PA limits & gain
gcode:
    {% if params.MIN %}  SAVE_VARIABLE VARIABLE=pa_min  VALUE={ params.MIN|float }  {% endif %}
    {% if params.MAX %}  SAVE_VARIABLE VARIABLE=pa_max  VALUE={ params.MAX|float }  {% endif %}
    {% if params.GAIN %} SAVE_VARIABLE VARIABLE=pa_gain VALUE={ params.GAIN|float } {% endif %}
    {% if params.DAMP %} SAVE_VARIABLE VARIABLE=pa_damp VALUE={ params.DAMP|float } {% endif %}

    RESPOND PREFIX="DPA" MSG="Updated config: min={ printer.save_variables.variables.pa_min }  max={ printer.save_variables.variables.pa_max }  gain={ printer.save_variables.variables.pa_gain }  damp={ printer.save_variables.variables.pa_damp }"


[gcode_macro DPA_OFF]
description: Disable Dynamic Pressure Advance System
gcode:
    SAVE_VARIABLE VARIABLE=dpa_enabled VALUE=False
    RESPOND PREFIX="DPA" MSG="Dynamic PA DISABLED"

    {% set base_pa = printer.save_variables.variables.base_pa|default(0.04)|float %}
    SET_PRESSURE_ADVANCE ADVANCE={ base_pa }
    RESPOND PREFIX="DPA" MSG="PA restored to base={ base_pa }}"




[gcode_macro DPA_SET_BASE]
description: Set base PA for this filament
gcode:
    {% set pa = params.PA|float %}
    SAVE_VARIABLE VARIABLE=base_pa VALUE={ pa }
    RESPOND PREFIX="DPA" MSG="Base Pressure Advance set to { pa }"

