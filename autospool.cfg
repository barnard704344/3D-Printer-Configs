# ======================================================================
# AUTO SPOOL CALIBRATION — SINGLE ACTIVE SPOOL (SAFE VERSION)
# No JSON, no dicts, no Jinja expressions inside RESPOND.
# ======================================================================

[save_variables]
filename: ~/printer_data/config/active_spool.cfg

# ================================================================
# SAVE ACTIVE SPOOL
# ================================================================
[gcode_macro SPOOL_SAVE]
description: Save spool name, flow, PA
gcode:
    {% set name = params.NAME|string %}
    {% set flow = params.FLOW|float %}
    {% set pa   = params.PA|float %}

    SAVE_VARIABLE VARIABLE=active_spool_name VALUE="{name}"
    SAVE_VARIABLE VARIABLE=active_flow VALUE={flow}
    SAVE_VARIABLE VARIABLE=active_pa VALUE={pa}

    {% set msg = "Saved spool " ~ name ~ " | Flow=" ~ flow ~ " | PA=" ~ pa %}
    RESPOND PREFIX="SPOOL" MSG="{msg}"

# ================================================================
# LOAD ACTIVE SPOOL
# ================================================================
[gcode_macro SPOOL_LOAD]
description: Apply previously stored spool values
gcode:
    {% set name = printer.save_variables.variables.active_spool_name|default("NONE") %}
    {% set flow = printer.save_variables.variables.active_flow|default(1.0)|float %}
    {% set pa   = printer.save_variables.variables.active_pa|default(0.04)|float %}

    M221 S{ flow * 100 }
    SET_PRESSURE_ADVANCE ADVANCE={ pa }

    {% set msg = "Loaded spool " ~ name ~ " | Flow=" ~ flow ~ " | PA=" ~ pa %}
    RESPOND PREFIX="SPOOL" MSG="{msg}"

# ================================================================
# RESET SPOOL DATA
# ================================================================
[gcode_macro SPOOL_RESET]
description: Reset stored spool settings
gcode:
    SAVE_VARIABLE VARIABLE=active_spool_name VALUE="NONE"
    SAVE_VARIABLE VARIABLE=active_flow VALUE=1.0
    SAVE_VARIABLE VARIABLE=active_pa VALUE=0.04

    RESPOND PREFIX="SPOOL" MSG="Active spool reset."

# ================================================================
# AUTO-CALIBRATE SPOOL
# ================================================================
[gcode_macro SPOOL_AUTOCAL]
description: Auto-calibrate spool using SFS slip %
gcode:
    {% set name = params.NAME|string %}
    {% set feed = params.FEED|default(100)|int %}

    {% set startmsg = "Starting auto calibration for spool " ~ name %}
    RESPOND PREFIX="SPOOL" MSG="{startmsg}"

    M104 S200
    M109 S200

    SAVE_VARIABLE VARIABLE=last_slip VALUE=0

    G91
    M83
    G1 E{feed} F300
    G90

    {% set slip = printer.save_variables.variables.last_slip|default(0)|float %}
    {% set slipmsg = "Measured slip = " ~ slip ~ "%" %}
    RESPOND PREFIX="SPOOL" MSG="{slipmsg}"

    # --- FLOW ---
    {% set new_flow = 1.0 + (slip / 100.0) %}
    {% if new_flow < 0.80 %}
        {% set new_flow = 0.80 %}
    {% elif new_flow > 1.20 %}
        {% set new_flow = 1.20 %}
    {% endif %}

    # --- PA ---
    {% set new_pa = 0.04 + (slip * 0.0025) %}
    {% if new_pa < 0.02 %}
        {% set new_pa = 0.02 %}
    {% elif new_pa > 0.20 %}
        {% set new_pa = 0.20 %}
    {% endif %}

    SAVE_VARIABLE VARIABLE=active_spool_name VALUE="{name}"
    SAVE_VARIABLE VARIABLE=active_flow VALUE={new_flow}
    SAVE_VARIABLE VARIABLE=active_pa VALUE={new_pa}

    M221 S{ new_flow * 100 }
    SET_PRESSURE_ADVANCE ADVANCE={ new_pa }

    {% set finalmsg = "CALIBRATED " ~ name ~ " → Flow=" ~ new_flow ~ " | PA=" ~ new_pa %}
    RESPOND PREFIX="SPOOL" MSG="{finalmsg}"
