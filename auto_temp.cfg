[save_variables]
filename: ~/printer_data/config/sfs_auto_flow_vars.cfg

[gcode_macro _AUTO_TEMP_CORE]
description: Hybrid Temp Boosting (Speed Feed-Forward + TMC Feedback)
variable_current_boost: 0.0
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set current_setpoint = printer.extruder.target|float %}
    
    # 1. Safety Check: Ensure we have a valid Base Temp saved
    {% set saved_base = vars.base_print_temp|default(0)|float %}
    
    {% if saved_base >= 170 and vars.at_enabled|default(False) %}
    
        # ---------------------------------------------------------
        # PART A: FEED-FORWARD (Speed/Flow Prediction)
        # ---------------------------------------------------------
        {% set filament_speed = printer.motion_report.live_extruder_velocity|float %}
        {% set vol_flow = filament_speed * 2.405 %} 
        
        {% set speed_k = vars.material_flow_k|default(0.0)|float %}
        {% set speed_boost = vol_flow * speed_k %}

        # ---------------------------------------------------------
        # PART B: FEEDBACK (TMC Motor Load)
        # ---------------------------------------------------------
        # NOTE: Ensure 'extruder_monitor' exists in your config!
        {% set load_val = printer["extruder_monitor"].load|default(-1)|int %}
        {% set no_load_baseline = 60 %} 
        
        # Thermal Compensation
        {% set board_temp = printer["temperature_sensor Toolhead_Temp"].temperature|default(30)|float %}
        {% set ref_temp = 35.0 %}
        {% set thermal_offset = (board_temp - ref_temp) * 0.4 %}
        {% if thermal_offset < 0 %} {% set thermal_offset = 0 %} {% endif %}
        
        # Calculate Strain
        {% set corrected_load = load_val + thermal_offset %}
        {% set strain = no_load_baseline - corrected_load %}
        
        # Filter Noise
        {% if strain < 0 %} {% set strain = 0 %} {% endif %}
        {% if strain < 10 %} {% set strain = 0 %} {% endif %}

        # Calculate Load Boost
        {% set load_k = vars.material_viscosity_k|default(0.0)|float %}
        {% set load_boost = strain * load_k %}

        # ---------------------------------------------------------
        # PART C: COMBINE & APPLY
        # ---------------------------------------------------------
        
        {% set raw_boost_target = speed_boost + load_boost %}

        # Clamp Max Boost (+30C Max)
        {% if raw_boost_target > 30.0 %} {% set raw_boost_target = 30.0 %} {% endif %}

        # Smoothing (Low Pass Filter)
        # FIX: Correctly access the macro variable
        {% set last_boost = printer["gcode_macro _AUTO_TEMP_CORE"].current_boost %}
        {% set smooth_boost = 0.0 %}

        {% if raw_boost_target > last_boost %}
            # Heat up fast (20%)
            {% set smooth_boost = (last_boost * 0.8) + (raw_boost_target * 0.2) %}
        {% else %}
            # Cool down slow (2%)
            {% set smooth_boost = (last_boost * 0.98) + (raw_boost_target * 0.02) %}
        {% endif %}
        
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE={smooth_boost}

        # Calculate Final Target using SAVED BASE only
        {% set new_target = (saved_base + smooth_boost)|round(0)|int %}

        # Absolute Safety Ceiling
        {% set max_limit = vars.at_max_temp|default(300)|int %}
        {% if new_target > max_limit %} {% set new_target = max_limit %} {% endif %}

        # Apply
        # Only apply if the target is actually changing to prevent spamming the MCU
        {% if load_val != -1 and new_target != current_setpoint|int %}
            M104 S{new_target}
        {% endif %}
        
    {% else %}
        # Reset boost if disabled or temp too low
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
        # Optional: Stop the loop if we aren't enabled to save resources
        {% if not vars.at_enabled|default(False) %}
            UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
        {% endif %}
    {% endif %}

# =========================================================
#  2. THE LOOP (Running every 1.0s)
# =========================================================
[delayed_gcode AUTO_TEMP_LOOP]
initial_duration: 0
gcode:
    {% if printer.save_variables.variables.at_enabled|default(False) %}
        _AUTO_TEMP_CORE
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

# =========================================================
#  3. CONTROL MACROS
# =========================================================

[gcode_macro AT_SET_K]
description: Set the Viscosity Multiplier (K-Value).
gcode:
    {% set k = params.K|default(0)|float %}
    SAVE_VARIABLE VARIABLE=material_viscosity_k VALUE={k}
    RESPOND MSG="Auto-Temp: Viscosity K set to {k}"

[gcode_macro AT_ENABLE]
description: Turn on Auto-Temp using current temp as base
gcode:
    {% set current_target = printer.extruder.target|float %}
    
    {% if current_target < 170 %}
        RESPOND TYPE=error MSG="Auto-Temp: ERROR. Heat nozzle first."
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% else %}
        SAVE_VARIABLE VARIABLE=base_print_temp VALUE={current_target}
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=True
        RESPOND MSG="Auto-Temp: Enabled. Base fixed at {current_target}C"
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_DISABLE]
description: Turn off Auto-Temp and return to base
gcode:
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    
    # Restore the base temp immediately
    {% set base = printer.save_variables.variables.base_print_temp|default(0)|float %}
    {% if base > 100 %}
        M104 S{base}
    {% endif %}
    
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    RESPOND MSG="Auto-Temp: Disabled."


[gcode_macro AT_SET_MAX]
description: Set absolute max temp for Auto-Temp
gcode:
    {% set max = params.MAX|default(300)|int %}
    SAVE_VARIABLE VARIABLE=at_max_temp VALUE={max}

[gcode_macro AT_TUNE_UP]
description: Increase Auto-Temp Sensitivity by 0.01
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set current_k = vars.material_viscosity_k|default(0)|float %}
    {% set new_k = (current_k + 0.01)|round(3) %}
    
    AT_SET_K K={new_k}

[gcode_macro AT_TUNE_DOWN]
description: Decrease Auto-Temp Sensitivity by 0.01
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set current_k = vars.material_viscosity_k|default(0)|float %}
    {% set new_k = (current_k - 0.01)|round(3) %}
    
    # Don't go below zero
    {% if new_k < 0 %} {% set new_k = 0 %} {% endif %}
    
    AT_SET_K K={new_k}


[gcode_macro AT_STATUS]
description: Report current Load, Strain, and Temp Boost
gcode:
    # 1. Get Vars
    {% set vars = printer.save_variables.variables %}
    {% set k = vars.material_viscosity_k|default(0)|float %}
    {% set base = vars.base_print_temp|default(0)|int %}
    {% set current = printer.extruder.target|int %}
    {% set load = printer["extruder_monitor"].load|default(-1)|int %}
    
    # 2. Get Thermal Data
    {% set board_temp = printer["temperature_sensor Toolhead_Temp"].temperature|default(30)|float %}
    {% set ref_temp = 35.0 %}
    {% set thermal_offset = (board_temp - ref_temp) * 0.4 %}
    {% if thermal_offset < 0 %} {% set thermal_offset = 0 %} {% endif %}
    
    # 3. Calculate Strain
    {% set baseline = 60 %} 
    {% set strain = baseline - (load + thermal_offset) %}
    
    # 4. Report
    RESPOND MSG="=== AUTO-TEMP STATUS ==="
    RESPOND MSG="K-Value: {k}"
    RESPOND MSG="Motor Load: {load} (Raw) + {thermal_offset|round(1)} (Thermal) = {load + thermal_offset|int} (Corrected)"
    RESPOND MSG="Strain: {strain|int} (Baseline {baseline})"
    RESPOND MSG="Temp: Base {base}C -> Current {current}C (Boost +{current - base}C)"
    RESPOND MSG="========================"


[gcode_macro AT_SET_FLOW_K]
description: Set Speed-Based Boost Multiplier (Feed-Forward)
gcode:
    {% set k = params.K|default(0)|float %}
    SAVE_VARIABLE VARIABLE=material_flow_k VALUE={k}
    RESPOND MSG="Auto-Temp: Flow/Speed K set to {k}"