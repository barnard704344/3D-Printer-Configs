[gcode_macro _AUTO_TEMP_CORE]
description: Proportional Temperature Boosting based on Viscosity K
gcode:
    {% set vars = printer.save_variables.variables %}
    
    # 1. Check if heater is active (Safety)
    {% set current_target = printer.extruder.target %}
    {% if current_target < 100 %}
        # Do nothing if cold
    {% else %}
    
        # 2. Get the "Boost Factor" (Viscosity K) set by PRINT_START
        {% set boost_k = vars.material_viscosity_k|default(0.0)|float %}
        
        # 3. Get Real-Time Flow
        {% set filament_speed = printer.motion_report.live_extruder_velocity|float %}
        {% set vol_flow = filament_speed * 2.405 %}

        # 4. Calculate Boost
        # Example: 20mm3/s * 1.2 = +24C boost
        {% set extra_heat = vol_flow * boost_k %}
        
        # ---------------------------------------------------------
        # SAFETY CLAMP: THIS IS WHERE IT GOES
        # Never boost more than +40C over base temp
        # ---------------------------------------------------------
        {% if extra_heat > 40.0 %}
            {% set extra_heat = 40.0 %}
        {% endif %}
        # ---------------------------------------------------------

        # 5. Calculate Final Target
        {% set base_temp = vars.base_print_temp|default(current_target)|float %}
        {% set new_target = base_temp + extra_heat %}

        # 6. Apply with Deadband (only change if > 2C difference)
        {% if (new_target - current_target)|abs > 2 %}
            M104 S{new_target|int}
        {% endif %}
        
    {% endif %}

[delayed_gcode AUTO_TEMP_LOOP]
initial_duration: 1.0
gcode:
    {% if printer.save_variables.variables.at_enabled|default(False) %}
        _AUTO_TEMP_CORE
        # Run every 1 second
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_ENABLE]
gcode:
    # Save the current slicer temp as the "Base"
    {% set current = printer.extruder.target %}
    SAVE_VARIABLE VARIABLE=base_print_temp VALUE={current}
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=True
    RESPOND MSG="Auto-Temp: Enabled. Base={current}C"
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0

[gcode_macro AT_DISABLE]
gcode:
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    
    # Restore the base temp immediately
    {% set base = printer.save_variables.variables.base_print_temp|default(0)|float %}
    {% if base > 100 %}
        M104 S{base}
    {% endif %}
    
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0