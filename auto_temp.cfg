[save_variables]
filename: ~/printer_data/config/sfs_auto_flow_vars.cfg

# =========================================================
#  1. CORE ENGINE (Smoothed Calculation)
# =========================================================
[gcode_macro _AUTO_TEMP_CORE]
description: Smoothed Temp Boosting based on Viscosity K
variable_current_boost: 0.0
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set current_setpoint = printer.extruder.target|float %}
    
    # Safety Check: Heater on & System Enabled
    {% if current_setpoint >= 170 and vars.at_enabled|default(False) %}
    
        # Get Settings
        {% set boost_k = vars.material_viscosity_k|default(0.0)|float %}
        {% set saved_base = vars.base_print_temp|default(0)|float %}
        
        # Sanity Check Base Temp
        {% if saved_base < 170 %}
             {% set base_temp = current_setpoint %}
        {% else %}
             {% set base_temp = saved_base %}
        {% endif %}

        # Calculate Raw Target
        {% set filament_speed = printer.motion_report.live_extruder_velocity|float %}
        {% set vol_flow = filament_speed * 2.405 %} 
        {% set raw_boost_target = vol_flow * boost_k %}

        # Clamp Max Boost (+40C Max)
        {% if raw_boost_target > 40.0 %} {% set raw_boost_target = 40.0 %} {% endif %}

        # Smoothing Logic
        {% set last_boost = current_boost %}
        {% set smooth_boost = 0.0 %}

        # Heat up fast (20% mix), Cool down slow (2% mix)
        {% if raw_boost_target > last_boost %}
            {% set smooth_boost = (last_boost * 0.8) + (raw_boost_target * 0.2) %}
        {% else %}
            {% set smooth_boost = (last_boost * 0.98) + (raw_boost_target * 0.02) %}
        {% endif %}
        
        # Save to RAM
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE={smooth_boost}

        # Apply Temperature (only if changed)
        {% set new_target = (base_temp + smooth_boost)|round(0)|int %}
        {% if new_target != current_setpoint %}
            M104 S{new_target}
        {% endif %}
        
    {% else %}
        # Reset if disabled
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    {% endif %}

# =========================================================
#  2. THE LOOP (Transmission)
# =========================================================
[delayed_gcode AUTO_TEMP_LOOP]
initial_duration: 1.0
gcode:
    {% if printer.save_variables.variables.at_enabled|default(False) %}
        _AUTO_TEMP_CORE
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

# =========================================================
#  3. COMMANDS (Called by PRINT_START)
# =========================================================

[gcode_macro AT_SET_K]
description: Set the Viscosity Multiplier (K-Value). Called by PRINT_START.
gcode:
    {% set k = params.K|default(0)|float %}
    SAVE_VARIABLE VARIABLE=material_viscosity_k VALUE={k}
    RESPOND MSG="Auto-Temp: Viscosity K set to {k}"

[gcode_macro AT_ENABLE]
description: Turn on Auto-Temp using current temp as base
gcode:
    {% set current_target = printer.extruder.target|float %}
    
    {% if current_target < 170 %}
        RESPOND TYPE=error MSG="Auto-Temp: ERROR. Heat nozzle first."
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% else %}
        SAVE_VARIABLE VARIABLE=base_print_temp VALUE={current_target}
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=True
        RESPOND MSG="Auto-Temp: Enabled. Base fixed at {current_target}C"
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_DISABLE]
description: Turn off Auto-Temp and return to base
gcode:
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    
    # Restore the base temp immediately
    {% set base = printer.save_variables.variables.base_print_temp|default(0)|float %}
    {% if base > 100 %}
        M104 S{base}
    {% endif %}
    
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    RESPOND MSG="Auto-Temp: Disabled."